@using DUTClinicManagement.Models

@{
    ViewData["Title"] = "Patient";
    Layout = "~/Views/Shared/_PagesLayout.cshtml";
}

<style>
    .card {
        border: none;
        border-radius: 8px;
        margin-bottom: 20px;
        background: white;
        width: 100%;
        height: 50vh;
        box-shadow: 0 4px 12px rgba(1, 1, 35, 0.6), 0 8px 24px rgba(1, 1, 35, 0.4);
    }


    .sport-coordinators-card {
    background-image: url('/UploadedFiles/food.jpeg');
    background-size: 100% 100%; 
    background-position: center;
    background-repeat: no-repeat;
    color: white;
    }


    .card-title {
    color: #010123;
    font-size: 35px;
    }

    .card-text {
    color: #022D36;
    }

    .sport-coordinators-card .card-title,
    .sport-coordinators-card .card-text {
    color: white;
    text-shadow: 1px 1px 2px black;
    }

    .btn-primary {
    background-color: #010123;
    color: #ffff;
    transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
    background-color: #ffff;
    color:#010123;
    }

    .btn-book {
    background-color: #010123;
    color: white;
    transition: background-color 0.3s ease;
    font-weight: 500;
    border-radius: 15px;
    }

    .btn-book:hover {
    background-color: #ffff;
    color: #010123;
    }

    .styled-button {
    background-color: #010123;
    color: #ffff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    text-decoration: none;
    border-radius:25px;
    }

    .custom-action-button {
    background-color: transparent;
    color: #48AAAD;
    border: 2px solid #48AAAD;
    padding: 10px 25px;
    font-weight: 500;
    border-radius: 25px;
    transition: background-color 0.3s ease, color 0.3s ease;
    text-decoration: none;
    cursor: pointer;
    }

    .custom-action-button:hover {
    background-color: #022D36;
    color: white;
    border-color: #022D36;
    }


    .styled-button span.arrow,
    .styled-book-button span.arrow {
    margin-left: 10px;
    }

    .center-number {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 30%;
    margin: 0;
    }

    h2 {
    color: #022D36;
    font-weight: bold;
    }
</style>

<br />


@if (TempData["Message"] != null)
{
    <div id="tempDataMessage" class="alert @(TempData["Message"].ToString().Contains("successfully") ? "alert-success" : "alert-danger")" role="alert">
        @Html.Raw(TempData["Message"])
        <span class="close" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </span>
    </div>
}

<div class="container">
<div class="row align-items-center mb-4">
    <div class="col-6">
        <h3>Hello @ViewBag.LoggedInUser</h3>
    </div>
<div class="col-6 d-flex justify-content-end align-items-center gap-3">

    <a asp-controller="Reminders" asp-action="Reminders"
       class="btn btn-warning position-relative d-flex align-items-center"
       style="border-radius: 25px; padding: 10px 16px; font-weight: 500;">
        
        <i class="fa fa-bell" style="font-size: 20px;"></i>
        <span class="d-none d-md-inline ms-2">Reminders</span>

        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            @* @ViewBag.ReminderCount *@2
        </span>
    </a>

    <a asp-controller="Chats" asp-action="Chats"
       class="btn btn-info position-relative d-flex align-items-center"
       style="border-radius: 25px; padding: 10px 16px; font-weight: 500;">
        
        <i class="fa fa-comments" style="font-size: 20px;"></i>
        <span class="d-none d-md-inline ms-2">Chats</span>

        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            @* @ViewBag.UnreadMessagesCount *@3
        </span>
    </a>

</div>

</div>

    <div class="row g-0 flex-column flex-lg-row" style="border-radius: 10px; overflow: hidden;">

        <div class="col-12 col-lg-4" style="padding: 5px;">
            <img src="~/Images/dut_nurses.jpg" alt="Medical Attention"
                 class="img-fluid w-100"
                 style="height: 100%; object-fit: contain; border-radius: 10px;" />
        </div>

        <div class="col-12 col-lg-8 d-flex" style="padding: 5px;">
            <div class="card-body d-flex flex-column w-100" style="border-radius: 10px;">
                <h3 class="card-title">Do you feel like you need any medical attention?</h3>
<p class="card-text">
    Our team is committed to providing quality care and will notify you of any changes or important updates regarding your bookings.
</p>

                <h1 class="card-text text-center center-number">@ViewBag.SportAdminsCount</h1>
                <a asp-controller="Appointments" asp-action="MakeAppointment"
                   class="btn btn-primary mt-auto align-self-end styled-button">
                    <span>Book Appointment</span>
                    <span class="arrow">&#10148;</span>
                </a>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" 
       style="width: 90%; max-width: 50%; height: 70vh; margin: auto;">
       
    <div class="modal-content" style="height: 100%;">
      <div class="modal-body" id="feedbackModalBody" style="height: 100%; overflow-y: auto;">
        
      </div>
    </div>

  </div>
</div>


<script>

    setTimeout(function () {
        var msg = document.getElementById("tempDataMessage");
        if (msg) {
            msg.style.display = "none";
        }
    }, 7000);
</script>

@if ((bool)(ViewBag.HasPendingFeedback ?? false))
{
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            setTimeout(() => {
                console.log("Fetching feedback form...");
                fetch("/Feedbacks/LoadFeedbackForm")
                    .then(response => {
                        console.log("Response status:", response.status);
                        if (response.status === 204) {
                            console.log("No content to load");
                            return null;
                        }
                        if (!response.ok) throw new Error("Failed to load feedback.");
                        return response.text();
                    })
                    .then(html => {
                        if (!html) return;
                        console.log("Feedback form HTML loaded, injecting...");
                        document.getElementById("feedbackModalBody").innerHTML = html;
                        const modal = new bootstrap.Modal(document.getElementById("feedbackModal"));
                        modal.show();

                        showPage(1);
                    })
                    .catch(err => {
                        console.error("Error loading feedback modal:", err);
                    });
            }, 3000);

            const feedbackForm = document.getElementById("feedbackForm");
            if (feedbackForm) {
                feedbackForm.addEventListener("submit", function (e) {
                    const c1 = document.getElementById("comment1")?.value.trim() ?? "";
                    const c2 = document.getElementById("comment2")?.value.trim() ?? "";
                    const c3 = document.getElementById("comment3")?.value.trim() ?? "";

                    let combined = "";
                    if (c1) combined += "Communication: " + c1 + "\n\n";
                    if (c2) combined += "Professionalism: " + c2 + "\n\n";
                    if (c3) combined += "Helpfulness: " + c3;

                    document.getElementById("commentsCombined").value = combined;
                });
            }
        });

        function showPage(pageNumber) {
            document.querySelectorAll(".rating-page").forEach(p => p.classList.add("d-none"));
            document.getElementById("page-" + pageNumber).classList.remove("d-none");
        }

        function saveCommentsAndShowPage(nextPage) {
            const c1 = document.getElementById("comment1").value.trim();
            const c2 = document.getElementById("comment2").value.trim();
            const c3 = document.getElementById("comment3").value.trim();

            let combined = "";
            if (c1) combined += "Communication: " + c1 + "\n\n";
            if (c2) combined += "Professionalism: " + c2 + "\n\n";
            if (c3) combined += "Helpfulness: " + c3;

            document.getElementById("commentsCombined").value = combined;
            showPage(nextPage);
        }
    </script>
}
