@model IEnumerable<DUTClinicManagement.ViewModels.MedicationCollectionViewModel>
@inject DUTClinicManagement.Interfaces.IEncryptionService encryptionService

@{
    ViewData["Title"] = "Medication";
    Layout = "~/Views/Shared/_PagesLayout.cshtml";
}

<head>
    <style>
        .btn-details,
        .btn-cancel {
            font-size: 1rem;
            padding: 6px 20px;
            border-radius: 8px;
        }

        .btn-details {
            background-color: #010123;
            color: white;
            border: none;
            margin-right: 6px;
        }

        .btn-details:hover {
            background-color: #580a9e;
        }

        .btn-cancel {
            background-color: transparent;
            border: 1px solid #ff4d4d;
            color: #ff4d4d;
        }

        .btn-cancel:hover {
            background-color: #ff4d4d;
            color: white;
        }

        .filter-btn.active {
            background-color: #022D36;
            color: white;
        }

        .appointment-card {
            border: 3px solid;
            border-radius: 15px;
            border-image-slice: 1;
            border-image-source: linear-gradient(135deg, #6a0dad, #8B0000, #33001c);
            background-color: white;
            padding: 1rem;
            box-sizing: border-box;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .appointment-header {
            font-weight: 600;
            color: #33001c;
        }

        .badge-status {
            background-color: #8B0000;
            color: white;
            padding: 0.25em 0.5em;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .modal-header.modal-header-custom {
            background-color: #010123;
            color: white;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }

        .form-label {
            font-weight: 600;
        }
    </style>
</head>

<br />

<div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between px-3 py-3 mb-4"
         style="background: linear-gradient(90deg, #010123 0%, #8B0000 50%, #FF0000 100%);
                border-radius: 0.75rem;">
        <div class="d-flex align-items-center">
            <a asp-controller="Home" asp-action="Index" class="text-white text-decoration-none d-inline-flex align-items-center back-link me-3">
                <i class="bi bi-chevron-left me-1"></i> Back
            </a>
            <h2 class="mb-0 text-white">Medications To be Collected</h2>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            You have no medications to collect.
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="appointmentsContainer">
            @foreach (var medication in Model)
            {
                var detailsModalId = $"detailsModal_{medication.MedicationPescriptionId}";
                var deliveryModalId = $"deliveryModal_{medication.MedicationPescriptionId}";

                <div class="col appointment-card-wrapper" data-status="@medication.Status">
                    <div class="card appointment-card rounded-4 p-3 h-100">
                        <div class="card-body pb-5">
                            <h5 class="appointment-header mb-3">
                                @(medication.Booking?.MedicalCondition)
                            </h5>
                            <p class="mb-1"><strong>Next Collection Date:</strong> @medication.NextCollectionDate?.ToString("MMMM dd, yyyy")</p>
                            <p class="mb-1"><strong>Status:</strong> <span>@medication.Status</span></p>
                        </div>

                        <div class="card-actions d-flex justify-content-end">
                            <button class="btn btn-details me-2" data-bs-toggle="modal" data-bs-target="#@detailsModalId">Details</button>
                            <button class="btn btn-cancel" data-bs-toggle="modal" data-bs-target="#@deliveryModalId">Request Delivery</button>
                        </div>
                    </div>

                    <div class="modal fade" id="@detailsModalId" tabindex="-1" aria-labelledby="@($"{detailsModalId}_Label")" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content rounded-4">
                                <div class="modal-header modal-header-custom">
                                    <h5 class="modal-title" id="@($"{detailsModalId}_Label")">Medication Collection Details</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>

                                <div class="modal-body d-flex flex-column align-items-start" style="font-size: 18px; padding:25px;">
                                    <dl class="row w-100">

                                        <dt class="col-sm-3 fw-semibold">Medication:</dt>
                                        <dd class="col-sm-9">
                                            @if (medication.PrescribedMedication != null && medication.PrescribedMedication.Any())
                                            {
                                                <ul class="list-unstyled mb-0">
                                                    @foreach (var med in medication.PrescribedMedication)
                                                    {
                                                        <li>- @med.MedicationName (D @med.DosageForm - S @med.Strength - @med.UnitOfMeasure)</li>
                                                    }
                                                </ul>
                                            }
                                            else
                                            {
                                                <span>N/A</span>
                                            }
                                        </dd>

                                        <dt class="col-sm-3 fw-semibold">Next Collection Date:</dt>
                                        <dd class="col-sm-9">@medication.NextCollectionDate?.ToString("dd MMM yyyy")</dd>

                                        <dt class="col-sm-3 fw-semibold">Last Collected:</dt>
                                        <dd class="col-sm-9">@medication.LastCollectionDate?.ToString("dd MMM yyyy")</dd>

                                        <dt class="col-sm-3 fw-semibold">Status:</dt>
                                        <dd class="col-sm-9"><span class="badge badge-status">@medication.Status</span></dd>

                                        <dt class="col-sm-3 fw-semibold">Final Collection Date:</dt>
                                        <dd class="col-sm-9">@medication.ExpiresAt?.ToString("dd MMM yyyy")</dd>

                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>



                  <div class="modal fade" id="@deliveryModalId" tabindex="-1" aria-labelledby="@($"{deliveryModalId}_Label")" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content rounded-4">

      <div class="modal-header modal-header-custom">
        <h5 class="modal-title" id="@($"{deliveryModalId}_Label")">Request Delivery</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form asp-controller="Deliveries" asp-action="NewDeliveryRequest" method="post" class="px-4 py-3 w-100">

        <input type="hidden" name="MedicationPescriptionId" value="@medication.MedicationPescriptionId" />
        <div class="modal-body" style="font-size: 18px; padding: 25px;">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="Street_@medication.MedicationPescriptionId">Street</label>
              <input type="text" class="form-control" id="Street_@medication.MedicationPescriptionId" name="Street" required value="@medication.Street" />
            </div>
            <div class="col-md-6">
              <label class="form-label" for="City_@medication.MedicationPescriptionId">City</label>
              <input type="text" class="form-control" id="City_@medication.MedicationPescriptionId" name="City" required value="@medication.City" />
            </div>
            <div class="col-md-6">
              <label class="form-label" for="Province_@medication.MedicationPescriptionId">Province</label>
              <select class="form-select" id="Province_@medication.MedicationPescriptionId" name="Province" required>
                @foreach (var prov in Enum.GetValues(typeof(DUTClinicManagement.Models.Province)))
                {
                    var isSelected = prov.Equals(medication.Province);
                    @:<option value="@prov"@(isSelected ? " selected" : "")>@prov</option>
                }
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="PostalCode_@medication.MedicationPescriptionId">Postal Code</label>
              <input type="text" class="form-control" id="PostalCode_@medication.MedicationPescriptionId" name="PostalCode" required value="@medication.PostalCode" />
            </div>
            <div class="col-md-12">
              <label class="form-label" for="Country_@medication.MedicationPescriptionId">Country</label>
              <input type="text" class="form-control" id="Country_@medication.MedicationPescriptionId" name="Country" required value="@medication.Country" />
            </div>
          </div>
        </div> 

        <div class="modal-footer">
          <button type="submit" id="addButton" class="btn btn-primary">Submit</button>
        </div>

      </form>

    </div>
  </div>
</div>

                </div>
            }
        </div>
    }
</div>
